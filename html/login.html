<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- ================================
         أسواق الخديوي - صفحة تسجيل الدخول
         ================================ -->
    <!-- هذه الصفحة تحتوي على:
         - نظام تسجيل الدخول بجوجل
         - عرض معلومات المستخدم
         - عرض المشتريات السابقة
         ================================ -->
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تسجيل الدخول | اسواق الخديوي</title>
    
    <!-- ================================
         PWA - Progressive Web App
         ================================ -->
    <meta name="theme-color" content="#1a5f7a">
    <meta name="apple-mobile-web-app-status-bar-style" content="#1a5f7a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="تسجيل الدخول إلى اسواق الخديوي وعرض مشترياتك السابقة">
    
    <!-- ================================
         مكتبات CSS و JavaScript
         ================================ -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- إضافة رمز الموقع المختصر (favicon) -->
    <link rel="icon" type="image/png" href="../images/logo22.png">
    <link rel="shortcut icon" type="image/png" href="../images/logo22.png">
    <link rel="apple-touch-icon" href="../images/logo22.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="../manifest.json">
    
    <!-- Firebase SDK لـ المتصفح -->
    <script type="module">
      // Import Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
      // Firebase config - إعدادات مشروعك
      const firebaseConfig = {
        apiKey: "AIzaSyCG1s3deiJmQVrvXCb_hSDj2STDYyXQXzM",
        authDomain: "hibr-2e6f7.firebaseapp.com",
        projectId: "hibr-2e6f7",
        storageBucket: "hibr-2e6f7.firebasestorage.app",
        messagingSenderId: "38236776445",
        appId: "1:38236776445:web:94d5c7112933a6084fdb94"
      };

      // Initialize Firebase
      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // جعل Firebase متاحاً عالمياً
        window.firebase = {
          app,
          auth: () => auth,
          firestore: () => db
        };
        
        // جعل الدوال متاحة عالمياً
        window.firebaseAuth = {
          GoogleAuthProvider,
          signInWithPopup,
          signOut,
          onAuthStateChanged
        };
        
        window.firebaseFirestore = {
          collection,
          query,
          where,
          orderBy,
          getDocs
        };
        
        console.log('تم تهيئة Firebase بنجاح في صفحة تسجيل الدخول');
        
      } catch (error) {
        console.error('خطأ في تهيئة Firebase:', error);
      }
    </script>
    
    <style>
        .login-container {
            max-width: 800px;
            margin: 120px auto 40px;
            padding: 0 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .login-header {
            background: linear-gradient(135deg, #1a5f7a 0%, #42c5ea 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .login-header h1 {
            margin: 0;
            font-size: 2rem;
            color: white;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .auth-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9e9e9;
            border-radius: 12px;
            text-align: center;
        }
        
        .auth-btn {
            padding: 12px 30px;
            border-radius: 25px;
            border: 2px solid #4285F4;
            background: #fff;
            color: #4285F4;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(66,133,244,0.15);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-btn:hover {
            background: #4285F4;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66,133,244,0.25);
        }
        
        .logout-btn {
            border-color: #d32f2f;
            color: #d32f2f;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
            color: #fff;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: block;
            border: 3px solid #42c5ea;
        }
        
        .user-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1a5f7a;
            margin-bottom: 5px;
        }
        
        .user-email {
            color: #666;
            margin-bottom: 15px;
        }
        
        .orders-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .orders-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9e9e9;
        }
        
        .orders-header h3 {
            margin: 0;
            color: #1a5f7a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .orders-list {
            padding: 20px;
        }
        
        .order-item {
            border: 1px solid #e9e9e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9e9e9;
        }
        
        .order-date {
            color: #666;
            font-size: 0.9rem;
        }
        
        .order-total {
            font-weight: bold;
            color: #1a5f7a;
        }
        
        .order-products {
            margin-bottom: 10px;
        }
        
        .order-product {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-product:last-child {
            border-bottom: none;
        }
        
        .product-name {
            color: #333;
        }
        
        .product-details {
            color: #666;
            font-size: 0.9rem;
        }
        
        .no-orders {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #1a5f7a;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: #42c5ea;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .login-container {
                margin: 100px auto 20px;
                padding: 0 15px;
            }
            
            .login-header {
                padding: 20px;
            }
            
            .login-header h1 {
                font-size: 1.5rem;
            }
            
            .login-body {
                padding: 20px;
            }
            
            .auth-btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
                font-size: 1rem;
                padding: 15px 20px;
                min-height: 50px;
            }
            
            .auth-section {
                margin-bottom: 20px;
                padding: 15px;
            }
            
            .auth-section h3 {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            
            .auth-section p {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }
        }
        
        /* تحسينات إضافية للهواتف المحمولة */
        @media (max-width: 480px) {
            .login-container {
                margin: 80px auto 10px;
                padding: 0 10px;
            }
            
            .login-header {
                padding: 15px;
            }
            
            .login-header h1 {
                font-size: 1.3rem;
            }
            
            .login-body {
                padding: 15px;
            }
            
            .auth-btn {
                font-size: 0.95rem;
                padding: 12px 15px;
                min-height: 45px;
            }
            
            .user-avatar {
                width: 60px;
                height: 60px;
            }
            
            .user-name {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="../images/logo22.png" alt="شعار الخديوي" class="logo" width="60" height="60">
            <h1>الخديوي</h1>
        </div>
        <nav class="main-menu" id="main-menu">
            <ul>
                <li><a href="index.html#home" class="menu-item"><i data-lucide="home"></i> الرئيسية</a></li>
                <li><a href="index.html#products" class="menu-item"><i data-lucide="shopping-bag"></i> المنتجات</a></li>
                <li><a href="index.html#daily-offers" class="menu-item"><i data-lucide="zap"></i> العروض اليومية</a></li>
                <li><a href="contact.html" class="menu-item"><i data-lucide="store"></i> عن المتجر</a></li>
            </ul>
        </nav>
    </header>

    <div class="login-container">
        <a href="index.html" class="back-btn">
            <i data-lucide="arrow-right"></i>
            العودة للرئيسية
        </a>
        
        <div class="login-card">
            <div class="login-header">
                <h1>تسجيل الدخول</h1>
                <p>سجل دخولك لعرض مشترياتك السابقة في الخديوي</p> 
            </div>
            
            <div class="login-body">
                <!-- قسم تسجيل الدخول -->
                <div class="auth-section" id="login-section">
                                    <h3>تسجيل الدخول</h3>
                <p>اضغط على الزر أدناه لتسجيل الدخول</p>
                    <button id="loginBtn" class="auth-btn">
                        <i class="fab fa-google"></i>
                        تسجيل الدخول
                    </button>
                </div>
                
                <!-- معلومات المستخدم (مخفي افتراضياً) -->
                <div class="user-info" id="user-info" style="display: none;">
                    <img id="user-avatar" src="" alt="صورة المستخدم" class="user-avatar">
                    <div class="user-name" id="user-name"></div>
                    <div class="email" id="user-email"></div>
                    <button id="logoutBtn" class="auth-btn logout-btn">
                        <i data-lucide="log-out"></i>
                        تسجيل الخروج
                    </button>
                </div>
                
                <!-- قسم الطلبات السابقة -->
                <div class="orders-section" id="orders-section" style="display: none;">
                    <div class="orders-header">
                        <h3>
                            <i data-lucide="shopping-bag"></i>
                            مشترياتك السابقة
                        </h3>
                    </div>
                    <div class="orders-list" id="orders-list">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            جاري تحميل مشترياتك...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // انتظار تهيئة Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.firebase && window.firebaseAuth && window.firebase.auth) {
                    resolve();
                } else {
                    setTimeout(() => waitForFirebase().then(resolve), 100);
                }
            });
        }

        let provider;

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // انتظار تهيئة Firebase
                await waitForFirebase();
                console.log('Firebase جاهز للاستخدام في صفحة تسجيل الدخول');
                
                // تهيئة provider
                provider = new window.firebaseAuth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');

        // مراقبة حالة تسجيل الدخول
        window.firebaseAuth.onAuthStateChanged(window.firebase.auth(), user => {
            console.log('تغيير حالة تسجيل الدخول:', user ? 'مسجل دخول' : 'غير مسجل');
            
            if (user) {
                // المستخدم مسجل دخول
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('orders-section').style.display = 'block';
                
                // عرض معلومات المستخدم
                document.getElementById('user-name').textContent = user.displayName || 'مستخدم';
                document.getElementById('user-email').textContent = user.email || '';
                
                if (user.photoURL) {
                    document.getElementById('user-avatar').src = user.photoURL;
                } else {
                    document.getElementById('user-avatar').src = '../images/logo22.png';
                }
                
                // تحميل الطلبات السابقة
                loadUserOrders(user.uid);
            } else {
                // المستخدم غير مسجل دخول
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('orders-section').style.display = 'none';
            }
        });

                 // زر تسجيل الدخول بجوجل
         document.getElementById('loginBtn').addEventListener('click', async () => {
             console.log('تم الضغط على زر تسجيل الدخول بجوجل');
            const loginBtn = document.getElementById('loginBtn');
             
             // تحقق من جاهزية Firebase
             if (!window.firebase || !window.firebaseAuth || !provider) {
                 console.error('Firebase غير جاهز');
                 alert('حدث خطأ في النظام. يرجى إعادة تحميل الصفحة');
                 return;
             }
             
             try {
                 console.log('محاولة تسجيل الدخول بجوجل...');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
            
                 const result = await window.firebaseAuth.signInWithPopup(window.firebase.auth(), provider);
                    const user = result.user;
                    console.log('تم تسجيل الدخول بنجاح:', user.displayName);
                    alert(`مرحبًا ${user.displayName || user.email}! تم تسجيل دخولك بنجاح.`);
                 
             } catch (error) {
                    console.error('خطأ في تسجيل الدخول:', error);
                    let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
                    
                    switch (error.code) {
                        case 'auth/popup-closed-by-user':
                         errorMessage = 'تم إغلاق نافذة تسجيل الدخول. يرجى المحاولة مرة أخرى';
                            break;
                        case 'auth/popup-blocked':
                         errorMessage = 'تم حظر النافذة المنبثقة. يرجى السماح للنوافذ المنبثقة';
                            break;
                        case 'auth/cancelled-popup-request':
                            errorMessage = 'تم إلغاء طلب تسجيل الدخول';
                            break;
                        case 'auth/network-request-failed':
                         errorMessage = 'خطأ في الاتصال بالشبكة. تحقق من اتصال الإنترنت';
                            break;
                        default:
                            errorMessage = `خطأ: ${error.message}`;
                    }
                    
                    alert(errorMessage);
                 
             } finally {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fab fa-google"></i> تسجيل الدخول';
             }
        });

        // زر تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', () => {
            console.log('محاولة تسجيل الخروج...');
            window.firebaseAuth.signOut(window.firebase.auth())
                .then(() => {
                    console.log('تم تسجيل الخروج بنجاح');
                    alert('تم تسجيل خروجك بنجاح');
                })
                .catch(error => {
                    console.error('خطأ في تسجيل الخروج:', error);
                    alert('حدث خطأ أثناء تسجيل الخروج');
                });
        });

            } catch (error) {
                console.error('خطأ في تهيئة صفحة تسجيل الدخول:', error);
            }
        });

        // تحميل الطلبات السابقة للمستخدم - يدعم هيكلين للبيانات
        async function loadUserOrders(userId) {
            try {
                console.log('بدء تحميل المشتريات للمستخدم:', userId);
                const ordersList = document.getElementById('orders-list');
                const db = window.firebase.firestore();
                
                let userOrders = [];
                
                // الطريقة الأولى: جلب من مجلد المستخدم (users/userId/purchases)
                try {
                    console.log('محاولة جلب المشتريات من مجلد المستخدم...');
                    const userPurchasesRef = window.firebaseFirestore.collection(db, "users", userId, "purchases");
                    const userPurchasesSnap = await window.firebaseFirestore.getDocs(userPurchasesRef);
                    
                    console.log('عدد المشتريات في مجلد المستخدم:', userPurchasesSnap.size);
                    
                    userPurchasesSnap.forEach((doc) => {
                        const data = doc.data();
                        console.log("Purchase from user folder:", doc.id, data);
                        userOrders.push({
                            id: doc.id,
                            items: [{
                                name: data.productName || data.name || 'منتج غير محدد',
                                quantity: data.quantity || 1,
                                price: data.price || 0
                            }],
                            total: data.price * data.quantity || data.total || 0,
                            orderDate: data.date || data.orderDate || new Date(),
                            source: 'user_folder'
                        });
                    });
                } catch (userFolderError) {
                    console.log('لا توجد مشتريات في مجلد المستخدم:', userFolderError.code);
                }
                
                // الطريقة الثانية: جلب من collection العام (orders)
                try {
                    console.log('محاولة جلب المشتريات من collection العام...');
                    const ordersRef = window.firebaseFirestore.collection(db, 'orders');
                    const ordersSnap = await window.firebaseFirestore.getDocs(ordersRef);
                    
                    console.log('عدد الطلبات الإجمالي في collection العام:', ordersSnap.size);
                    
                    ordersSnap.forEach((doc) => {
                        const data = doc.data();
                        console.log('طلب في collection العام:', doc.id, 'userId:', data.userId, 'المطلوب:', userId);
                        
                        // تحقق من أن الطلب يخص هذا المستخدم
                        if (data.userId === userId) {
                            userOrders.push({
                                id: doc.id,
                                items: data.items || [],
                                total: data.total || 0,
                                orderDate: data.orderDate,
                                source: 'orders_collection'
                            });
                        }
                    });
                } catch (ordersError) {
                    console.log('خطأ في جلب المشتريات من collection العام:', ordersError.code);
                }
                
                console.log('إجمالي عدد المشتريات المجمعة:', userOrders.length);
                
                if (userOrders.length === 0) {
                    ordersList.innerHTML = '<div class="no-orders">لا توجد مشتريات سابقة لهذا المستخدم</div>';
                    return;
                }
                
                // ترتيب الطلبات حسب التاريخ (الأحدث أولاً)
                userOrders.sort((a, b) => {
                    const dateA = a.orderDate ? (a.orderDate.toDate ? a.orderDate.toDate() : new Date(a.orderDate)) : new Date(0);
                    const dateB = b.orderDate ? (b.orderDate.toDate ? b.orderDate.toDate() : new Date(b.orderDate)) : new Date(0);
                    return dateB.getTime() - dateA.getTime();
                });
                
                // بناء HTML للطلبات
                let ordersHTML = '';
                userOrders.forEach(order => {
                    // معالجة التاريخ
                    let orderDateStr = 'غير محدد';
                    if (order.orderDate) {
                        try {
                            const date = order.orderDate.toDate ? order.orderDate.toDate() : new Date(order.orderDate);
                            orderDateStr = date.toLocaleDateString('ar-EG');
                        } catch (e) {
                            console.warn('خطأ في تحويل التاريخ:', e);
                        }
                    }
                    
                    // بناء قائمة المنتجات
                    let productsHTML = '';
                    if (order.items && Array.isArray(order.items) && order.items.length > 0) {
                        order.items.forEach(item => {
                            productsHTML += `
                                <div class="order-product">
                                    <span class="product-name">${item.name || item.productName || 'منتج غير محدد'}</span>
                                    <span class="product-details">${item.quantity || 0} × ${item.price || 0} ج.م</span>
                                </div>
                            `;
                        });
                    } else {
                        productsHTML = '<div class="order-product">لا توجد تفاصيل المنتجات</div>';
                    }
                    
                    // إضافة مصدر البيانات للتشخيص
                    const sourceLabel = order.source === 'user_folder' ? '(مجلد المستخدم)' : '(المجموعة العامة)';
                    
                    // إضافة الطلب إلى HTML
                    ordersHTML += `
                        <div class="order-item">
                            <div class="order-header">
                                <span class="order-date">${orderDateStr} ${sourceLabel}</span>
                                <span class="order-total">${order.total || 0} ج.م</span>
                            </div>
                            <div class="order-products">
                                ${productsHTML}
                            </div>
                        </div>
                    `;
                });
                
                ordersList.innerHTML = ordersHTML;
                console.log('تم عرض المشتريات بنجاح من مصادر متعددة');
                
            } catch (error) {
                console.error('خطأ عام في تحميل الطلبات:', error);
                console.error('تفاصيل الخطأ:', error.message);
                console.error('كود الخطأ:', error.code);
                
                let errorMessage = 'حدث خطأ في تحميل المشتريات السابقة';
                if (error.code === 'permission-denied') {
                    errorMessage = 'ليس لديك صلاحية للوصول إلى المشتريات';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'الخدمة غير متاحة حالياً، حاول لاحقاً';
                }
                
                document.getElementById('orders-list').innerHTML = `<div class="no-orders">${errorMessage}</div>`;
            }
        }

        // إنشاء الأيقونات
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>

