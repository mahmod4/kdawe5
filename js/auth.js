// ================================
// Ù…Ù„Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth) Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
// ================================
// Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
// Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
// - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
// - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù…Ù†
// - Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
// - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
// - Ø­Ù…Ø§ÙŠØ© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js'; // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js'; // Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
import { auth, db } from './firebase-config.js'; // Ø®Ø¯Ù…Ø§Øª Firebase Ø§Ù„Ù…Ù‡ÙŠØ£Ø©

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ Firestore
export async function checkAdminStatus(userId) {
    try {
        // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù†ÙØ³ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID)
        const userDoc = await getDoc(doc(db, 'admins', userId));
        console.log('Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…ÙˆØ¬ÙˆØ¯:', userDoc.exists()); // ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯
        
        if (userDoc.exists()) {
            const data = userDoc.data(); // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù†:', data); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ´Ø®ÙŠØµ
            console.log('Ù‚ÙŠÙ…Ø© isAdmin:', data.isAdmin, 'Ø§Ù„Ù†ÙˆØ¹:', typeof data.isAdmin); // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ÙˆØ¹
            
            // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© boolean true (ÙˆÙ„ÙŠØ³ string) Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            return data.isAdmin === true;
        }
        return false; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
    } catch (error) {
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø£Ø¯Ù…Ù† Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù„ÙˆØ­Ø©
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù†:', error);
        return false;
    }
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// ØªÙ‚ÙˆÙ… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
export async function login(email, password) {
    try {
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Firebase Auth Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù€:', userCredential.user.uid);
        
        // Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ù†ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ø¨Ø± Firestore
        const isAdmin = await checkAdminStatus(userCredential.user.uid);
        console.log('Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù†:', isAdmin);
        
        if (!isAdmin) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø£Ø¯Ù…Ù†: Ù†Ø³Ø¬Ù„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ù‹Ø§ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù„ÙˆØ­Ø©
            await signOut(auth);
            
            // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…ÙØµÙ„Ø© Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© (Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚Ù„)
            const userDoc = await getDoc(doc(db, 'admins', userCredential.user.uid));
            let errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….\n\n';
            
            if (!userDoc.exists()) {
                // Ø­Ø§Ù„Ø©: Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                errorMessage += `âŒ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firestore.\n\n`;
                errorMessage += `ðŸ“‹ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:\n`;
                errorMessage += `1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Firestore Database\n`;
                errorMessage += `2. Ø£Ù†Ø´Ø¦ Collection: admins\n`;
                errorMessage += `3. Document ID: ${userCredential.user.uid}\n`;
                errorMessage += `4. Ø£Ø¶Ù Field: isAdmin (boolean) = true\n\n`;
                errorMessage += `User UID: ${userCredential.user.uid}`;
            } else {
                // Ø­Ø§Ù„Ø©: Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ø¨Ù‡ Ù…Ø´ÙƒÙ„Ø©
                const data = userDoc.data();
                errorMessage += `âš ï¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ†:\n\n`;
                
                if (data.isAdmin === undefined) {
                    errorMessage += `âŒ Ø§Ù„Ø­Ù‚Ù„ isAdmin ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯\n`;
                } else if (typeof data.isAdmin !== 'boolean') {
                    errorMessage += `âŒ Ø§Ù„Ø­Ù‚Ù„ isAdmin Ù…Ù† Ù†ÙˆØ¹ ${typeof data.isAdmin} (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† boolean)\n`;
                    errorMessage += `Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${data.isAdmin}\n\n`;
                } else if (data.isAdmin === false) {
                    errorMessage += `âŒ Ø§Ù„Ø­Ù‚Ù„ isAdmin = false (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† true)\n`;
                } else {
                    errorMessage += `âŒ Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ. ØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.`;
                }
                errorMessage += `\n\nUser UID: ${userCredential.user.uid}`;
            }
            
            // Ù†Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            throw new Error(errorMessage);
        }
        
        return userCredential.user; // Ø¥Ø±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    } catch (error) {
        // Ø£ÙŠ Ø®Ø·Ø£: Ù†Ø±Ø¬Ø¹Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¥Ù† ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
        
        // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (error.message) {
            throw error;
        }
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ¯ÙŠÙ„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        throw new Error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
    }
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
// ØªÙ‚ÙˆÙ… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Auth
export async function logout() {
    try {
        await signOut(auth); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
    }
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ±Ø§Ù‚Ø¨ ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù…Ø±Ø±Ø© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
export function onAuthStateChange(callback) {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„: Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø«Ù… Ù†Ø¨Ù„Øº main.js
            const isAdmin = await checkAdminStatus(user.uid); // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
            callback(user, isAdmin); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
        } else {
            // Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            callback(null, false); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­Ø§Ù„Ø© Ø£Ø¯Ù…Ù† false
        }
    });
}

